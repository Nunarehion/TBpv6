import"../chunks/Bzak7iHL.js";import{o as Ue}from"../chunks/bhRhCqWC.js";import{p as be,b as f,s as v,f as U,e as l,n as o,a as d,d as Se,ab as b,aC as H,r as i,t as O,c as C,aF as z}from"../chunks/CnxLOvM0.js";import{e as j,s as D}from"../chunks/BFpeZ14H.js";import{i as g,s as ye,a as S}from"../chunks/DulKp6NI.js";import{e as Te}from"../chunks/DVubXfnJ.js";import{r as At}from"../chunks/CNL2E_I9.js";import{b as Mt}from"../chunks/BV2Y1Hvn.js";import{b as Bt}from"../chunks/COlTbjMT.js";import{w as y}from"../chunks/5VKP8Fpw.js";import{L as Yt}from"../chunks/JpeHBfzh.js";var Ae=f('<p class="error-message svelte-14x6c00"> </p>'),Me=f('<p class="info-message svelte-14x6c00">Загрузка общей статистики пользователей...</p>'),Ie=f('<div class="user-stats-card svelte-14x6c00"><p class="stat-label svelte-14x6c00">Общее количество уникальных пользователей</p> <p class="stat-value svelte-14x6c00"> </p></div>'),Ce=f(`<p class="info-message svelte-14x6c00">Общая статистика пользователей пока не загружена. Выберите даты и нажмите "Обновить
					статистику".</p>`),Ne=f('<p class="info-message svelte-14x6c00">Загрузка данных для графика новых пользователей...</p>'),$e=f('<p class="error-message svelte-14x6c00"> </p>'),Ee=f('<p class="info-message svelte-14x6c00">Нет данных для отображения графика новых пользователей за выбранный период.</p>'),je=f('<p class="info-message svelte-14x6c00">Загрузка данных для графика активных пользователей...</p>'),Le=f('<p class="error-message svelte-14x6c00"> </p>'),Oe=f('<p class="info-message svelte-14x6c00">Нет данных для отображения графика активных пользователей за выбранный период.</p>'),ke=f('<p class="error-message svelte-14x6c00"> </p>'),Fe=f('<p class="info-message svelte-14x6c00">Загрузка данных о самых активных пользователях...</p>'),He=f('<tr class="svelte-14x6c00"><td class="svelte-14x6c00"> </td><td class="svelte-14x6c00"> </td><td class="svelte-14x6c00"> </td><td class="svelte-14x6c00"> </td><td class="svelte-14x6c00"> </td></tr>'),Re=f('<div class="table-container svelte-14x6c00"><table class="svelte-14x6c00"><thead><tr><th class="svelte-14x6c00">ID Пользователя</th><th class="svelte-14x6c00">Имя пользователя</th><th class="svelte-14x6c00">Имя</th><th class="svelte-14x6c00">Фамилия</th><th class="svelte-14x6c00">Количество взаимодействий</th></tr></thead><tbody class="svelte-14x6c00"></tbody></table></div>'),Be=f('<p class="info-message svelte-14x6c00">Нет данных о самых активных пользователях за выбранный период.</p>'),Ye=f('<h1 class="svelte-14x6c00">Статистика Пользователей</h1> <section class="stat-section control-panel svelte-14x6c00"><div class="stats-controls-row svelte-14x6c00"><div class="input-date-group svelte-14x6c00"><label for="statStartDate" class="svelte-14x6c00">Начальная дата:</label> <input type="date" id="statStartDate" min="2020-01-01" max="2030-12-31" class="svelte-14x6c00"/></div> <div class="input-date-group svelte-14x6c00"><label for="statEndDate" class="svelte-14x6c00">Конечная дата:</label> <input type="date" id="statEndDate" min="2020-01-01" max="2030-12-31" class="svelte-14x6c00"/></div> <button class="update-button svelte-14x6c00">Обновить статистику</button> <div class="summary-content-placeholder svelte-14x6c00"><!></div></div></section> <section class="stat-section svelte-14x6c00"><h2 class="svelte-14x6c00">Новые пользователи по времени (Линейный график)</h2> <div class="input-group-container svelte-14x6c00"><label for="intervalNewUsers" class="svelte-14x6c00">Интервал:</label> <select id="intervalNewUsers" class="svelte-14x6c00"><option>По часам</option><option>По дням</option><option>По месяцам</option></select></div> <div class="chart-container svelte-14x6c00"><!></div></section> <section class="stat-section svelte-14x6c00"><h2 class="svelte-14x6c00">Активные пользователи по времени (Линейный график)</h2> <div class="input-group-container svelte-14x6c00"><label for="intervalActiveUsers" class="svelte-14x6c00">Интервал:</label> <select id="intervalActiveUsers" class="svelte-14x6c00"><option>По часам</option><option>По дням</option><option>По месяцам</option></select></div> <div class="chart-container svelte-14x6c00"><!></div></section> <section class="stat-section svelte-14x6c00"><h2 class="svelte-14x6c00">Самые активные пользователи</h2> <div class="input-group-container svelte-14x6c00"><div class="svelte-14x6c00"><label for="mostActiveLimit" class="svelte-14x6c00">Показать:</label> <input type="number" id="mostActiveLimit" min="1" max="100" class="svelte-14x6c00"/></div> <button class="update-button svelte-14x6c00">Обновить список</button></div> <!></section>',1);function ts(Pt,qt){be(qt,!0);const[w,zt]=ye(),Gt=()=>S(V,"$newUsersTimeSeriesData",w),Jt=()=>S(X,"$activeUsersTimeSeriesData",w),T=()=>S(x,"$apiError",w),Kt=()=>S(Q,"$loadingTotalUsersStatistics",w),G=()=>S(K,"$totalUsersStatistics",w),Qt=()=>S(W,"$loadingNewUsersTimeSeriesData",w),Vt=()=>S(Z,"$loadingActiveUsersTimeSeriesData",w),Wt=()=>S(et,"$loadingMostActiveUsersData",w),J=()=>S(tt,"$mostActiveUsersData",w),K=y(null),Q=y(!1),V=y([]),W=y(!1),X=y([]),Z=y(!1),tt=y([]),et=y(!1),x=y(null);let A=H(""),M=H(""),N=H("day"),st=H(10),L=H(!1);const It=[],R=t=>{It.push(t)};function at(t){if(!t)return"";const e=t.split("-").map(Number);return new Date(Date.UTC(e[0],e[1]-1,e[2],0,0,0,0)).toISOString()}function rt(t){if(!t)return"";const e=t.split("-").map(Number);return new Date(Date.UTC(e[0],e[1]-1,e[2],23,59,59,999)).toISOString()}async function Xt(t,e){Q.set(!0),x.set(null);try{const n=`/api/statistics/users/total?startDate=${t}&endDate=${e}`,r=await fetch(n);if(!r.ok){const s=await r.json();throw new Error(s.error||"Ошибка загрузки общей статистики пользователей")}const a=await r.json();K.set(a)}catch(n){x.set(n.message),K.set(null)}finally{Q.set(!1)}}async function Zt(t,e,n){W.set(!0),x.set(null);try{const r=`/api/statistics/users/new-over-time?startDate=${t}&endDate=${e}&interval=${n}`,a=await fetch(r);if(!a.ok){const c=await a.json();throw new Error(c.error||"Ошибка загрузки временного ряда новых пользователей")}const s=await a.json();V.set(s)}catch(r){x.set(r.message),V.set([])}finally{W.set(!1)}}async function te(t,e,n){Z.set(!0),x.set(null);try{const r=`/api/statistics/users/active-over-time?startDate=${t}&endDate=${e}&interval=${n}`,a=await fetch(r);if(!a.ok){const c=await a.json();throw new Error(c.error||"Ошибка загрузки временного ряда активных пользователей")}const s=await a.json();X.set(s)}catch(r){x.set(r.message),X.set([])}finally{Z.set(!1)}}async function ee(t,e,n){et.set(!0),x.set(null);try{const r=`/api/statistics/users/most-active?startDate=${t}&endDate=${e}&limit=${n}`,a=await fetch(r);if(!a.ok){const c=await a.json();throw new Error(c.error||"Ошибка загрузки самых активных пользователей")}const s=await a.json();tt.set(s)}catch(r){x.set(r.message),tt.set([])}finally{et.set(!1)}}async function I(){x.set(null);const t=at(o(A)),e=rt(o(M));if(!t||!e||isNaN(new Date(t).getTime())||isNaN(new Date(e).getTime())){x.set("Пожалуйста, выберите корректные начальную и конечную даты.");return}for(const n of It)await n(t,e,o(N))}Ue(async()=>{const t=new Date,e=new Date(t);e.setDate(t.getDate()+1),b(M,e.toISOString().slice(0,10),!0);const n=new Date(t.getTime()-10080*60*1e3);b(A,n.toISOString().slice(0,10),!0),R(async(r,a)=>{await B(Xt,r,a)}),R(async(r,a,s)=>{await B(Zt,r,a,s)}),R(async(r,a,s)=>{await B(te,r,a,s)}),R(async(r,a)=>{await B(ee,r,a,o(st))}),await I()});async function B(t,...e){b(L,!0);const n=Date.now();await t(...e);const r=Date.now()-n,a=300;r<a&&await new Promise(s=>setTimeout(s,a-r)),b(L,!1)}function Ct(t,e,n){const r=[];let a=new Date(t);const s=new Date(e);for(["day","month"].includes(n)&&a.setUTCHours(0,0,0,0);a<=s;)r.push(new Date(a)),n==="hour"?a.setUTCHours(a.getUTCHours()+1):n==="day"?a.setUTCDate(a.getUTCDate()+1):n==="month"?a.setUTCMonth(a.getUTCMonth()+1):a.setUTCDate(a.getUTCDate()+1);return r}let $=z(()=>{const t=Gt(),e=o(N);if(!o(A)||!o(M)||t.length===0)return[];const n=at(o(A)),r=rt(o(M)),a=Ct(n,r,e),s=new Map;return t.forEach(p=>{s.set(new Date(p.time).toISOString(),p.count)}),a.map(p=>{const _=p.toISOString(),h=s.get(_)||0;return{time:_,count:h}})}),E=z(()=>{const t=Jt(),e=o(N);if(!o(A)||!o(M)||t.length===0)return[];const n=at(o(A)),r=rt(o(M)),a=Ct(n,r,e),s=new Map;return t.forEach(p=>{s.set(new Date(p.time).toISOString(),p.count)}),a.map(p=>{const _=p.toISOString(),h=s.get(_)||0;return{time:_,count:h}})}),se=z(()=>{if(!o($)||o($).length===0)return 10;const t=Math.max(...o($).map(r=>r.count)),e=10,n=t*.1;return Math.max(1,Math.ceil(t+e+n))}),ae=z(()=>{if(!o(E)||o(E).length===0)return 10;const t=Math.max(...o(E).map(r=>r.count)),e=10,n=t*.1;return Math.max(1,Math.ceil(t+e+n))});var Nt=Ye(),ot=v(U(Nt),2),$t=l(ot),nt=l($t),ct=v(l(nt),2);At(ct),i(nt);var it=v(nt,2),lt=v(l(it),2);At(lt),i(it);var Et=v(it,2),jt=v(Et,2),re=l(jt);{var oe=t=>{var e=Ae(),n=l(e);i(e),O(()=>D(n,`Ошибка: ${T()??""}`)),d(t,e)},ne=t=>{var e=C(),n=U(e);{var r=s=>{var c=Me();d(s,c)},a=s=>{var c=C(),p=U(c);{var _=u=>{var m=Ie(),k=v(l(m),2),q=l(k,!0);i(k),i(m),O(()=>D(q,G().count)),d(u,m)},h=u=>{var m=Ce();d(u,m)};g(p,u=>{G()&&G().count!==void 0?u(_):u(h,!1)},!0)}d(s,c)};g(n,s=>{Kt()||o(L)?s(r):s(a,!1)},!0)}d(t,e)};g(re,t=>{T()?t(oe):t(ne,!1)})}i(jt),i($t),i(ot);var vt=v(ot,2),ut=v(l(vt),2),Y=v(l(ut),2),dt=l(Y);dt.value=dt.__value="hour";var pt=v(dt);pt.value=pt.__value="day";var Lt=v(pt);Lt.value=Lt.__value="month",i(Y),i(ut);var Ot=v(ut,2),ce=l(Ot);{var ie=t=>{var e=Ne();d(t,e)},le=t=>{var e=C(),n=U(e);{var r=s=>{var c=$e(),p=l(c);i(c),O(()=>D(p,`Ошибка загрузки данных для графика новых пользователей: ${T()??""}`)),d(s,c)},a=s=>{var c=C(),p=U(c);{var _=u=>{Yt(u,{get data(){return o($)},get yAxisMax(){return o(se)}})},h=u=>{var m=Ee();d(u,m)};g(p,u=>{o($)&&o($).length>0?u(_):u(h,!1)},!0)}d(s,c)};g(n,s=>{T()&&o($).length===0?s(r):s(a,!1)},!0)}d(t,e)};g(ce,t=>{Qt()||o(L)?t(ie):t(le,!1)})}i(Ot),i(vt);var ft=v(vt,2),mt=v(l(ft),2),P=v(l(mt),2),_t=l(P);_t.value=_t.__value="hour";var gt=v(_t);gt.value=gt.__value="day";var kt=v(gt);kt.value=kt.__value="month",i(P),i(mt);var Ft=v(mt,2),ve=l(Ft);{var ue=t=>{var e=je();d(t,e)},de=t=>{var e=C(),n=U(e);{var r=s=>{var c=Le(),p=l(c);i(c),O(()=>D(p,`Ошибка загрузки данных для графика активных пользователей: ${T()??""}`)),d(s,c)},a=s=>{var c=C(),p=U(c);{var _=u=>{Yt(u,{get data(){return o(E)},get yAxisMax(){return o(ae)}})},h=u=>{var m=Oe();d(u,m)};g(p,u=>{o(E)&&o(E).length>0?u(_):u(h,!1)},!0)}d(s,c)};g(n,s=>{T()&&o(E).length===0?s(r):s(a,!1)},!0)}d(t,e)};g(ve,t=>{Vt()||o(L)?t(ue):t(de,!1)})}i(Ft),i(ft);var Ht=v(ft,2),xt=v(l(Ht),2),ht=l(xt),Dt=v(l(ht),2);At(Dt),i(ht);var pe=v(ht,2);i(xt);var fe=v(xt,2);{var me=t=>{var e=ke(),n=l(e);i(e),O(()=>D(n,`Ошибка: ${T()??""}`)),d(t,e)},_e=t=>{var e=C(),n=U(e);{var r=s=>{var c=Fe();d(s,c)},a=s=>{var c=C(),p=U(c);{var _=u=>{var m=Re(),k=l(m),q=v(l(k));Te(q,5,J,wt=>wt.user_id,(wt,F)=>{var Ut=He(),bt=l(Ut),ge=l(bt,!0);i(bt);var St=v(bt),xe=l(St,!0);i(St);var yt=v(St),he=l(yt,!0);i(yt);var Tt=v(yt),De=l(Tt,!0);i(Tt);var Rt=v(Tt),we=l(Rt,!0);i(Rt),i(Ut),O(()=>{D(ge,o(F).user_id),D(xe,o(F).username||"-"),D(he,o(F).first_name||"-"),D(De,o(F).last_name||"-"),D(we,o(F).interactionCount)}),d(wt,Ut)}),i(q),i(k),i(m),d(u,m)},h=u=>{var m=Be();d(u,m)};g(p,u=>{J()&&J().length>0?u(_):u(h,!1)},!0)}d(s,c)};g(n,s=>{Wt()||o(L)?s(r):s(a,!1)},!0)}d(t,e)};g(fe,t=>{T()?t(me):t(_e,!1)})}i(Ht),Mt(ct,()=>o(A),t=>b(A,t)),j("change",ct,I),Mt(lt,()=>o(M),t=>b(M,t)),j("change",lt,I),j("click",Et,I),Bt(Y,()=>o(N),t=>b(N,t)),j("change",Y,I),Bt(P,()=>o(N),t=>b(N,t)),j("change",P,I),Mt(Dt,()=>o(st),t=>b(st,t)),j("change",Dt,I),j("click",pe,I),d(Pt,Nt),Se(),zt()}export{ts as component};
