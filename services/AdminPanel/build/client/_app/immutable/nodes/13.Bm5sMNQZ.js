import"../chunks/Bzak7iHL.js";import{o as jt}from"../chunks/bhRhCqWC.js";import{p as $t,j as Zt,b as p,e as v,r as u,a as f,d as Bt,s as l,f as x,n as r,ab as S,aC as F,c as B,aF as Dt,t as G,aD as te}from"../chunks/CnxLOvM0.js";import{e as R,s as J}from"../chunks/BFpeZ14H.js";import{i as C,s as ee,a as M}from"../chunks/DulKp6NI.js";import{r as Ct}from"../chunks/CNL2E_I9.js";import{b as wt}from"../chunks/BV2Y1Hvn.js";import{b as ae}from"../chunks/COlTbjMT.js";import{w as P}from"../chunks/5VKP8Fpw.js";import{C as se,L as ne}from"../chunks/JpeHBfzh.js";import{b as oe}from"../chunks/CFJY2ZC6.js";import{p as It}from"../chunks/h1hal1Ui.js";var re=p('<div class="chart-wrapper svelte-1y6qpxw"><canvas></canvas></div>');function ie(K,O){$t(O,!0);let m=It(O,"data",19,()=>[]),Q=It(O,"title",3,"Клики по паттернам"),T,A=null;const W=getComputedStyle(document.documentElement).getPropertyValue("--gray-text").trim()||"#9ca3af",w=getComputedStyle(document.documentElement).getPropertyValue("--main-text").trim()||"#ffffff";getComputedStyle(document.documentElement).getPropertyValue("--second-color").trim(),getComputedStyle(document.documentElement).getPropertyValue("--border-gray").trim();function X(g){const y=[];for(let _=0;_<g;_++){const h=_*137.508%360;y.push(`hsl(${h}, 70%, 60%)`)}return y}function E(){if(!T){console.warn("Элемент canvas не найден или не готов для отрисовки графика.");return}A&&A.destroy();const g=m().map(h=>h.pattern),y=m().map(h=>h.count),_=X(g.length);A=new se(T,{type:"pie",data:{labels:g,datasets:[{data:y,backgroundColor:_,hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:Q(),color:W,font:{size:16}},legend:{position:"right",labels:{color:w}}}}})}jt(()=>{E()}),Zt(()=>{m()&&T&&E()});var L=re(),N=v(L);oe(N,g=>T=g,()=>T),u(L),f(K,L),Bt()}var le=p('<p class="info-message transition-fade svelte-ubnqvv">Загрузка данных для линейного графика...</p>'),ce=p('<p class="error-message transition-fade svelte-ubnqvv"> </p>'),ve=p('<p class="info-message transition-fade svelte-ubnqvv">Нет данных для отображения линейного графика за выбранный период.</p>'),ue=p('<p class="error-message transition-fade svelte-ubnqvv"> </p>'),fe=p('<p class="info-message transition-fade svelte-ubnqvv">Загрузка общей статистики...</p>'),de=p('<div class="stats-card transition-fade svelte-ubnqvv"><p class="stat-value svelte-ubnqvv"> </p> <p class="stat-label svelte-ubnqvv">Количество кликов</p></div>'),pe=p('<p class="info-message transition-fade svelte-ubnqvv">Общая статистика пока не загружена. Выберите даты и нажмите "Обновить статистику".</p>'),me=p('<p class="info-message transition-fade svelte-ubnqvv">Загрузка данных для кругового графика...</p>'),ge=p('<p class="error-message transition-fade svelte-ubnqvv"> </p>'),_e=p('<p class="info-message transition-fade svelte-ubnqvv">Нет данных для отображения кругового графика за выбранный период.</p>'),he=p('<h1 class="svelte-ubnqvv">Статистика Бота</h1> <section class="stat-section svelte-ubnqvv"><h2 class="svelte-ubnqvv">Статистика кликов по времени (Линейный график)</h2> <div class="input-group-container svelte-ubnqvv"><label for="interval" class="svelte-ubnqvv">Интервал:</label> <select id="interval" class="svelte-ubnqvv"><option>По минутам</option><option>По 10 минут</option><option>По полчаса</option><option>По 12 часов</option><option>По часам</option><option>По дням</option><option>По неделям</option><option>По месяцам</option></select></div> <div class="chart-container svelte-ubnqvv"><!></div></section> <section class="stat-section svelte-ubnqvv"><h2 class="svelte-ubnqvv">Общая статистика</h2> <div class="input-group-container svelte-ubnqvv"><div class="svelte-ubnqvv"><label for="statStartDate" class="svelte-ubnqvv">Начальная дата:</label> <input type="date" id="statStartDate" min="2020-01-01" max="2030-12-31" class="svelte-ubnqvv"/></div> <div class="svelte-ubnqvv"><label for="statEndDate" class="svelte-ubnqvv">Конечная дата:</label> <input type="date" id="statEndDate" min="2020-01-01" max="2030-12-31" class="svelte-ubnqvv"/></div> <div class="svelte-ubnqvv"><label for="statPattern" class="svelte-ubnqvv">Паттерн (опционально):</label> <input type="text" id="statPattern" placeholder="Например, query/button_1" class="svelte-ubnqvv"/></div> <button class="update-button svelte-ubnqvv">Обновить статистику</button></div> <div class="summary-content-placeholder svelte-ubnqvv"><!></div></section> <section class="stat-section svelte-ubnqvv"><h2 class="svelte-ubnqvv">Статистика кликов по паттернам (Круговой график)</h2> <div class="input-group-container svelte-ubnqvv"></div> <div class="chart-container svelte-ubnqvv"><!></div></section>',1);function Pe(K,O){$t(O,!0);const[m,Q]=ee(),T=()=>M(y,"$timeSeriesData",m),A=()=>M(h,"$clicksByPatternData",m),W=()=>M(_,"$loadingTimeSeriesData",m),w=()=>M(b,"$apiError",m),X=()=>M(g,"$loadingClickStatistics",m),E=()=>M(N,"$clickStatistics",m),L=()=>M(Z,"$loadingClicksByPatternData",m),N=P(null),g=P(!1),y=P([]),_=P(!1),h=P([]),Z=P(!1),b=P(null);let I=F(""),j=F(""),V=F("hour"),tt=F(""),H=F(!1);const yt=[],et=t=>{yt.push(t)};function qt(t){if(!t)return"";const a=t.split("-").map(Number);return new Date(Date.UTC(a[0],a[1]-1,a[2],0,0,0,0)).toISOString()}function St(t){if(!t)return"";const a=t.split("-").map(Number);return new Date(Date.UTC(a[0],a[1]-1,a[2],23,59,59,999)).toISOString()}async function Ot(t,a,s=null){g.set(!0),b.set(null);try{let o=`/api/statistics/clicks/total?startDate=${t}&endDate=${a}`;s&&(o+=`&pattern=${encodeURIComponent(s)}`);const e=await fetch(o);if(!e.ok){const i=await e.json();throw new Error(i.error||"Ошибка загрузки общей статистики кликов")}const n=await e.json();N.set(n)}catch(o){b.set(o.message),N.set(null)}finally{g.set(!1)}}async function At(t,a,s){_.set(!0),b.set(null);try{const o=`/api/statistics/clicks/time-series?startDate=${t}&endDate=${a}&interval=${s}`,e=await fetch(o);if(!e.ok){const i=await e.json();throw new Error(i.error||"Ошибка загрузки временного ряда кликов")}const n=await e.json();y.set(n)}catch(o){b.set(o.message),y.set([])}finally{_.set(!1)}}async function Lt(t,a){Z.set(!0),b.set(null);try{const s=`/api/statistics/clicks/by-pattern?startDate=${t}&endDate=${a}`,o=await fetch(s);if(!o.ok){const n=await o.json();throw new Error(n.error||"Ошибка загрузки кликов по паттернам")}const e=await o.json();h.set(e)}catch(s){b.set(s.message),h.set([])}finally{Z.set(!1)}}async function $(){b.set(null);const t=qt(r(I)),a=St(r(j));if(!t||!a||isNaN(new Date(t).getTime())||isNaN(new Date(a).getTime())){b.set("Пожалуйста, выберите корректные начальную и конечную даты.");return}for(const s of yt)await s(t,a,r(V))}jt(async()=>{const t=new Date,a=new Date(t);a.setDate(t.getDate()+1),S(j,a.toISOString().slice(0,10),!0);const s=new Date(t.getTime()-10080*60*1e3);S(I,s.toISOString().slice(0,10),!0),et(async(o,e)=>{await at(Ot,o,e,r(tt))}),et(async(o,e,n)=>{await at(At,o,e,n)}),et(async(o,e)=>{await at(Lt,o,e)}),await $()});async function at(t,...a){S(H,!0);const s=Date.now();await t(...a);const o=Date.now()-s,e=300;o<e&&await new Promise(n=>setTimeout(n,e-o)),S(H,!1)}function Nt(t,a,s){const o=[];let e=new Date(t);const n=new Date(a);for(["day","week","month","3_days","4_months"].includes(s)&&e.setUTCHours(0,0,0,0);e<=n;)o.push(new Date(e)),s==="minute"?e.setUTCMinutes(e.getUTCMinutes()+1):s==="hour"?e.setUTCHours(e.getUTCHours()+1):s==="day"?e.setUTCDate(e.getUTCDate()+1):s==="month"?e.setUTCMonth(e.getUTCMonth()+1):s==="10_minutes"?e.setUTCMinutes(e.getUTCMinutes()+10):s==="half_hour"?e.setUTCMinutes(e.getUTCMinutes()+30):s==="12_hours"?e.setUTCHours(e.getUTCHours()+12):s==="3_days"?e.setUTCDate(e.getUTCDate()+3):s==="week"?e.setUTCDate(e.getUTCDate()+7):s==="4_months"?e.setUTCMonth(e.getUTCMonth()+4):e.setUTCDate(e.getUTCDate()+1);return o}let k=Dt(()=>{const t=T(),a=r(V);if(!r(I)||!r(j)||!t||t.length===0)return[];const s=qt(r(I)),o=St(r(j)),e=Nt(s,o,a),n=new Map;return t.forEach(d=>{n.set(d.time,d.count)}),e.map(d=>{const q=d.toISOString(),U=n.get(q)||0;return{time:q,count:U}})}),Ht=Dt(()=>{if(!r(k)||r(k).length===0)return 10;const t=r(k).reduce((o,e)=>Math.max(o,e.count),0),a=10,s=t*.1;return Math.max(1,Math.ceil(t+a+s))}),z=Dt(()=>A());var Tt=he(),st=l(x(Tt),2),nt=l(v(st),2),Y=l(v(nt),2),ot=v(Y);ot.value=ot.__value="minute";var rt=l(ot);rt.value=rt.__value="10_minutes";var it=l(rt);it.value=it.__value="half_hour";var lt=l(it);lt.value=lt.__value="12_hours";var ct=l(lt);ct.value=ct.__value="hour";var vt=l(ct);vt.value=vt.__value="day";var ut=l(vt);ut.value=ut.__value="week";var kt=l(ut);kt.value=kt.__value="month",u(Y),u(nt);var Ut=l(nt,2),Ft=v(Ut);{var Rt=t=>{var a=le();f(t,a)},Vt=t=>{var a=B(),s=x(a);{var o=n=>{var i=ce(),d=v(i);u(i),G(()=>J(d,`Ошибка загрузки данных для линейного графика: ${w()??""}`)),f(n,i)},e=n=>{var i=B(),d=x(i);{var q=c=>{ne(c,{get data(){return r(k)},get yAxisMax(){return r(Ht)}})},U=c=>{var D=ve();f(c,D)};C(d,c=>{r(k)&&r(k).length>0?c(q):c(U,!1)},!0)}f(n,i)};C(s,n=>{w()&&r(k).length===0?n(o):n(e,!1)},!0)}f(t,a)};C(Ft,t=>{W()||r(H)?t(Rt):t(Vt,!1)})}u(Ut),u(st);var ft=l(st,2),dt=l(v(ft),2),pt=v(dt),mt=l(v(pt),2);Ct(mt),u(pt);var gt=l(pt,2),_t=l(v(gt),2);Ct(_t),u(gt);var ht=l(gt,2),bt=l(v(ht),2);Ct(bt),u(ht);var zt=l(ht,2);u(dt);var xt=l(dt,2),Yt=v(xt);{var Gt=t=>{var a=ue(),s=v(a);u(a),G(()=>J(s,`Ошибка: ${w()??""}`)),f(t,a)},Jt=t=>{var a=B(),s=x(a);{var o=n=>{var i=fe();f(n,i)},e=n=>{var i=B(),d=x(i);{var q=c=>{var D=de(),Et=v(D),Xt=v(Et,!0);u(Et),te(2),u(D),G(()=>J(Xt,E().count)),f(c,D)},U=c=>{var D=pe();f(c,D)};C(d,c=>{E()&&E().count!==void 0?c(q):c(U,!1)},!0)}f(n,i)};C(s,n=>{X()||r(H)?n(o):n(e,!1)},!0)}f(t,a)};C(Yt,t=>{w()?t(Gt):t(Jt,!1)})}u(xt),u(ft);var Mt=l(ft,2),Pt=l(v(Mt),4),Kt=v(Pt);{var Qt=t=>{var a=me();f(t,a)},Wt=t=>{var a=B(),s=x(a);{var o=n=>{var i=ge(),d=v(i);u(i),G(()=>J(d,`Ошибка загрузки данных для кругового графика: ${w()??""}`)),f(n,i)},e=n=>{var i=B(),d=x(i);{var q=c=>{ie(c,{get data(){return r(z)}})},U=c=>{var D=_e();f(c,D)};C(d,c=>{r(z)&&r(z).length>0?c(q):c(U,!1)},!0)}f(n,i)};C(s,n=>{w()&&r(z).length===0?n(o):n(e,!1)},!0)}f(t,a)};C(Kt,t=>{L()||r(H)?t(Qt):t(Wt,!1)})}u(Pt),u(Mt),ae(Y,()=>r(V),t=>S(V,t)),R("change",Y,$),wt(mt,()=>r(I),t=>S(I,t)),R("change",mt,$),wt(_t,()=>r(j),t=>S(j,t)),R("change",_t,$),wt(bt,()=>r(tt),t=>S(tt,t)),R("change",bt,$),R("click",zt,$),f(K,Tt),Bt(),Q()}export{Pe as component};
