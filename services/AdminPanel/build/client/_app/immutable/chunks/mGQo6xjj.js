import"./Bzak7iHL.js";import{c as Ke,o as rt}from"./bhRhCqWC.js";import{p as Pe,aC as A,aa as Ve,b as g,e as i,s as c,c as W,f as L,n as e,a,r as l,t as O,d as Je,ab as r,aF as Ye,aE as Fe,j as xt,aB as kt,aD as ct}from"./CnxLOvM0.js";import{i as w,a as tt,s as St}from"./DulKp6NI.js";import{p as Le}from"./h1hal1Ui.js";import{s as Y,e as p,r as ft}from"./BFpeZ14H.js";import{e as Ne,i as We}from"./DVubXfnJ.js";import{t as nt,s as st,a as Ct}from"./DqKLfdG-.js";import{r as He,s as Be}from"./CNL2E_I9.js";import{s as bt}from"./m49QtOYO.js";import{b as Ie,a as ut}from"./BV2Y1Hvn.js";import{p as lt}from"./Bfc47y5P.js";import{b as Dt}from"./COlTbjMT.js";import{b as vt}from"./CFJY2ZC6.js";import{w as at}from"./5VKP8Fpw.js";import"./69_IOA4Y.js";import{s as Et}from"./DbhJMJeT.js";var Tt=g('<div class="form-group svelte-u3n4x2"><label class="svelte-u3n4x2"> </label> <input type="text" class="form-input svelte-u3n4x2"/></div>'),Mt=g('<div class="modal-overlay svelte-u3n4x2"><div class="modal-content svelte-u3n4x2"><h3 class="svelte-u3n4x2">Редактировать документ</h3> <form><!> <div class="modal-actions svelte-u3n4x2"><button type="submit" class="action-button save-button svelte-u3n4x2">Сохранить</button> <button type="button" class="action-button cancel-button svelte-u3n4x2">Отмена</button></div></form></div></div>');function At(we,o){Pe(o,!0);const N=Ke();let m=A(Ve({...o.doc}));function s(H,U){r(m,{...e(m),[U]:H.target.value},!0)}function S(){N("save",e(m))}function f(){N("cancel")}var h=Mt(),j=i(h),ae=c(i(j),2),q=i(ae);Ne(q,17,()=>o.columns,We,(H,U)=>{var B=W(),F=L(B);{var $=P=>{var ne=Tt(),I=i(ne),J=i(I);l(I);var ie=c(I,2);He(ie),l(ne),O(()=>{Be(I,"for",`edit-${e(U)}`),Y(J,`${e(U)??""}:`),Be(ie,"id",`edit-${e(U)}`)}),Ie(ie,()=>e(m)[e(U)],De=>e(m)[e(U)]=De),p("input",ie,De=>s(De,e(U))),a(P,ne)};w(F,P=>{e(U)!=="_id"&&P($)})}a(H,B)});var le=c(q,2),oe=c(i(le),2);l(le),l(ae),l(j),l(h),p("click",oe,f),p("submit",ae,lt(S)),a(we,h),Je()}var Bt=g('<span class="label-text svelte-j3cgqq"> </span>'),zt=g('<label class="toggle-switch svelte-j3cgqq"><input type="checkbox" class="svelte-j3cgqq"/> <span class="slider round svelte-j3cgqq"></span> <!></label>');function Rt(we,o){Pe(o,!0);let N=Le(o,"checked",7,!1),m=Le(o,"label",3,"");const s=Ke();function S(q){s("change",q.target.checked)}var f=zt(),h=i(f);He(h);var j=c(h,4);{var ae=q=>{var le=Bt(),oe=i(le,!0);l(le),O(()=>Y(oe,m())),a(q,le)};w(j,q=>{m()&&q(ae)})}l(f),ut(h,N),p("change",h,S),a(we,f),Je()}var Lt=g('<div class="form-group svelte-1g7wnnt"><label class="svelte-1g7wnnt"> </label> <input type="text" class="svelte-1g7wnnt"/></div>'),Nt=g('<div class="keyboard-button svelte-1g7wnnt" draggable="true"><span class="svelte-1g7wnnt"> </span> <span class="callback-data-display svelte-1g7wnnt"> </span> <button type="button" class="remove-button svelte-1g7wnnt">&times;</button></div>'),jt=g('<div class="empty-drop-target">Перетащите кнопки сюда, чтобы добавить в эту строку</div>'),Ht=g('<button type="button" class="merge-row-button svelte-1g7wnnt">Слить с предыдущей строкой</button>'),It=g('<div class="button-row svelte-1g7wnnt"><!> <!> <!></div>'),Ot=g('<div class="empty-keyboard-drop-target"></div>'),Ut=g("<p>Загрузка доступных кнопок...</p>"),Ft=g('<p class="error-message svelte-1g7wnnt"> </p>'),Kt=g('<div class="available-button svelte-1g7wnnt" draggable="true"><span class="svelte-1g7wnnt"> </span> <span class="callback-data-display svelte-1g7wnnt"> </span></div>'),Pt=g("<p>Кнопки в коллекции 'кнопко' не найдены. Добавьте их сначала!</p>"),Jt=g('<p class="error-message svelte-1g7wnnt"> </p>'),qt=g('<div class="modal-overlay svelte-1g7wnnt"><div class="modal-content svelte-1g7wnnt"><h2 class="svelte-1g7wnnt">Редактировать клавиатуру</h2> <form><!> <div class="form-group keyboard-builder-section svelte-1g7wnnt"><label class="svelte-1g7wnnt">Расположение кнопок:</label> <div class="keyboard-preview svelte-1g7wnnt"><!> <div class="add-row-drop-zone svelte-1g7wnnt">Перетащите кнопку сюда, чтобы создать новую строку</div> <!></div></div> <div class="form-group available-buttons-section svelte-1g7wnnt"><label class="svelte-1g7wnnt">Доступные кнопки:</label> <div class="available-buttons-list svelte-1g7wnnt"><!></div> <div class="new-button-creator svelte-1g7wnnt"><input type="text" placeholder="Текст новой кнопки" class="svelte-1g7wnnt"/> <input type="text" placeholder="Callback Data" class="svelte-1g7wnnt"/> <button type="button" class="create-new-button svelte-1g7wnnt"><!></button></div> <!></div> <div class="modal-actions svelte-1g7wnnt"><button type="submit" class="action-button save-button svelte-1g7wnnt">Сохранить</button> <button type="button" class="action-button cancel-button svelte-1g7wnnt">Отмена</button></div></form></div></div>');function _t(we,o){Pe(o,!0);let N=Le(o,"columns",19,()=>[]);const m=Ke();let s=A(Ve({...o.doc,buttons:o.doc.buttons&&Array.isArray(o.doc.buttons)?o.doc.buttons.map(n=>Array.isArray(n)?n.map(t=>({id:t.id})):[]):[]})),S=A(null),f=A(null),h=A(null),j=A(!1),ae=A(Ve([])),q=A(!0),le=A(null),oe=A(""),H=A(""),U=A(!1),B=A(null);async function F(){r(q,!0),r(le,null);try{const n=await fetch("/api/buttons");if(!n.ok)throw new Error(`Failed to fetch 'buttons' buttons: ${n.statusText}`);const t=await n.json();r(ae,t.map(d=>({id:d._id,text:d.text||d.label||d.name||`Кнопка ${String(d._id).slice(-4)}`,callback_data:d.callback_data||""})),!0)}catch(n){r(le,n.message,!0)}finally{r(q,!1)}}rt(async()=>{await F()});function $(n){const t=e(ae).find(d=>d.id===n);return{text:t?t.text:"Нет текста",callback_data:t?t.callback_data:"Нет данных"}}function P(n,t){r(s,{...e(s),[n]:t.target.value},!0)}function ne(n,t,d=-1,k=-1,ee=!1){r(S,t,!0),r(f,d,!0),r(h,k,!0),r(j,ee,!0),n.dataTransfer.effectAllowed="move"}function I(n){n.preventDefault(),n.dataTransfer.dropEffect="move"}function J(n,t,d=-1){if(n.preventDefault(),!e(S))return;let k=JSON.parse(JSON.stringify(e(s).buttons));const ee={id:e(S).id};let K=!1,M=e(f);!e(j)&&e(f)!==-1&&e(h)!==-1&&k[e(f)]&&k[e(f)][e(h)]!==void 0&&(k[e(f)].splice(e(h),1),k[e(f)].length===0&&(k.splice(e(f),1),K=!0)),K&&M<t&&t--,t===-1?k.push([ee]):(k[t]===void 0&&(t>=0&&t<=k.length?k.splice(t,0,[]):(k.push([]),t=k.length-1)),d===-1?k[t].push(ee):d>=0&&d<=k[t].length?k[t].splice(d,0,ee):k[t].push(ee)),e(s).buttons=k,r(S,null),r(f,null),r(h,null),r(j,!1)}function ie(n){if(n.preventDefault(),!e(S))return;let t=JSON.parse(JSON.stringify(e(s).buttons));const d={id:e(S).id};!e(j)&&e(f)!==-1&&e(h)!==-1&&t[e(f)]&&t[e(f)][e(h)]!==void 0&&(t[e(f)].splice(e(h),1),t[e(f)].length===0&&t.splice(e(f),1)),t.push([d]),e(s).buttons=t,r(S,null),r(f,null),r(h,null),r(j,!1)}function De(n){if(n.preventDefault(),!e(S)||e(j)||e(f)===-1)return;let t=JSON.parse(JSON.stringify(e(s).buttons));t[e(f)]&&t[e(f)][e(h)]!==void 0&&(t[e(f)].splice(e(h),1),t[e(f)].length===0&&t.splice(e(f),1)),e(s).buttons=t,r(S,null),r(f,null),r(h,null),r(j,!1)}function z(n,t){let d=JSON.parse(JSON.stringify(e(s).buttons));d[n].splice(t,1),d[n].length===0&&d.splice(n,1),e(s).buttons=d}function se(n){if(n===0)return;let t=JSON.parse(JSON.stringify(e(s).buttons));const d=t.splice(n,1)[0];t[n-1]=[...t[n-1],...d],e(s).buttons=t}function ke(){const n=e(s).buttons.map(t=>t.map(d=>({id:d.id})));m("save",{...e(s),buttons:n})}function x(){m("cancel")}async function y(){if(r(B,null),!e(oe).trim()||!e(H).trim()){r(B,"Пожалуйста, введите текст и callback_data для новой кнопки.");return}r(U,!0);try{const n=await fetch("/api/buttons",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e(oe).trim(),callback_data:e(H).trim()})});if(!n.ok){const t=await n.json();throw new Error(t.message||"Ошибка при создании кнопки на сервере.")}await F(),r(oe,""),r(H,"")}catch(n){r(B,n.message,!0)}finally{r(U,!1)}}var T=qt(),he=i(T),be=c(i(he),2),C=i(be);Ne(C,17,N,We,(n,t)=>{var d=W(),k=L(d);{var ee=K=>{var M=Lt(),X=i(M),Ee=i(X);l(X);var V=c(X,2);He(V),l(M),O(D=>{Be(X,"for",e(t)),Y(Ee,`${D??""}:`),Be(V,"id",e(t))},[()=>e(t).replace(/_/g," ")]),Ie(V,()=>e(s)[e(t)],D=>e(s)[e(t)]=D),p("input",V,D=>P(e(t),D)),a(K,M)};w(k,K=>{e(t)!=="_id"&&e(t)!=="buttons"&&K(ee)})}a(n,d)});var ce=c(C,2),ye=c(i(ce),2),ue=i(ye);Ne(ue,17,()=>e(s).buttons,We,(n,t,d)=>{var k=It(),ee=i(k);Ne(ee,17,()=>e(t),We,(V,D,te)=>{var ge=Nt();const Ce=Ye(()=>$(e(D).id));var Me=i(ge),Ae=i(Me,!0);l(Me);var pe=c(Me,2),ze=i(pe,!0);l(pe);var qe=c(pe,2);l(ge),O(()=>{Y(Ae,e(Ce).text),Y(ze,e(Ce).callback_data)}),p("click",qe,()=>z(d,te)),p("dragstart",ge,Oe=>ne(Oe,e(D),d,te,!1)),p("dragover",ge,I),p("drop",ge,Oe=>J(Oe,d,te)),a(V,ge)});var K=c(ee,2);{var M=V=>{var D=jt();p("dragover",D,I),p("drop",D,te=>J(te,d,-1)),a(V,D)};w(K,V=>{e(t).length===0&&V(M)})}var X=c(K,2);{var Ee=V=>{var D=Ht();p("click",D,()=>se(d)),a(V,D)};w(X,V=>{e(s).buttons.length>1&&d>0&&V(Ee)})}l(k),p("dragover",k,I),p("drop",k,V=>J(V,d,-1)),a(n,k)});var ve=c(ue,2),Te=c(ve,2);{var me=n=>{var t=Ot();p("dragover",t,I),p("drop",t,d=>J(d,-1)),a(n,t)};w(Te,n=>{e(s).buttons.length===0&&n(me)})}l(ye),l(ce);var G=c(ce,2),de=c(i(G),2),re=i(de);{var Re=n=>{var t=Ut();a(n,t)},Se=n=>{var t=W(),d=L(t);{var k=K=>{var M=Ft(),X=i(M);l(M),O(()=>Y(X,`Ошибка загрузки кнопок: ${e(le)??""}`)),a(K,M)},ee=K=>{var M=W(),X=L(M);{var Ee=D=>{var te=W(),ge=L(te);Ne(ge,17,()=>e(ae),Ce=>Ce.id,(Ce,Me)=>{var Ae=Kt();const pe=Ye(()=>$(e(Me).id));var ze=i(Ae),qe=i(ze,!0);l(ze);var Oe=c(ze,2),Ue=i(Oe,!0);l(Oe),l(Ae),O(()=>{Y(qe,e(pe).text),Y(Ue,e(pe).callback_data)}),p("dragstart",Ae,je=>ne(je,e(Me),-1,-1,!0)),a(Ce,Ae)}),a(D,te)},V=D=>{var te=Pt();a(D,te)};w(X,D=>{e(ae).length>0?D(Ee):D(V,!1)},!0)}a(K,M)};w(d,K=>{e(le)?K(k):K(ee,!1)},!0)}a(n,t)};w(re,n=>{e(q)?n(Re):n(Se,!1)})}l(de);var fe=c(de,2),_e=i(fe);He(_e);var R=c(_e,2);He(R);var xe=c(R,2),u=i(xe);{var _=n=>{var t=Fe("Создание...");a(n,t)},Z=n=>{var t=Fe("Создать новую кнопку");a(n,t)};w(u,n=>{e(U)?n(_):n(Z,!1)})}l(xe),l(fe);var v=c(fe,2);{var b=n=>{var t=Jt(),d=i(t,!0);l(t),O(()=>Y(d,e(B))),a(n,t)};w(v,n=>{e(B)&&n(b)})}l(G);var E=c(G,2),Q=c(i(E),2);l(E),l(be),l(he),l(T),O(()=>xe.disabled=e(U)),p("dragover",ve,I),p("drop",ve,ie),p("dragover",de,I),p("drop",de,De),Ie(_e,()=>e(oe),n=>r(oe,n)),Ie(R,()=>e(H),n=>r(H,n)),p("keydown",R,n=>{n.key==="Enter"&&(n.preventDefault(),y())}),p("click",xe,y),p("click",Q,x),p("submit",be,lt(ke)),nt(3,T,()=>st),a(we,T),Je()}var Qt=g('<p class="error-message svelte-vbcn1b"> </p>'),Vt=g('<p class="error-message svelte-vbcn1b"> </p>'),Wt=g("<p>Загрузка картинок...</p>"),Gt=g('<p class="error-message svelte-vbcn1b"> </p>'),Xt=g("<p>Пока нет загруженных картинок.</p>"),Yt=g('<div class="checkmark svelte-vbcn1b">✔</div>'),Zt=g('<div><img class="svelte-vbcn1b"/> <!></div>'),$t=g('<div class="image-grid svelte-vbcn1b"></div>'),ea=g('<div class="modal-overlay svelte-vbcn1b"><div class="modal-content svelte-vbcn1b"><h3 class="svelte-vbcn1b">Выбор и загрузка картинок</h3> <div class="upload-section svelte-vbcn1b"><h4 class="svelte-vbcn1b">Загрузить новую картинку</h4> <div class="file-input-group svelte-vbcn1b"><input type="file" id="imageUploadInput" accept="image/*" hidden/> <label for="imageUploadInput" class="file-label-with-button svelte-vbcn1b"><span class="custom-file-button svelte-vbcn1b">Выбрать файл</span> <span class="file-name-display svelte-vbcn1b"> </span></label></div> <button class="svelte-vbcn1b"><!></button> <!> <!></div> <hr class="svelte-vbcn1b"/> <div class="existing-images-section"><h4 class="svelte-vbcn1b">Доступные картинки</h4> <!></div> <div class="modal-actions svelte-vbcn1b"><button class="svelte-vbcn1b"> </button> <button class="svelte-vbcn1b">Отмена</button></div></div></div>');function ta(we,o){Pe(o,!0);const[N,m]=St(),s=()=>tt(le,"$images",N),S=()=>tt(H,"$loadingImageUpload",N),f=()=>tt(U,"$error",N),h=()=>tt(oe,"$loadingImages",N),j=Ke(),ae="/api/images",q="http://admin_backend:3000",le=at([]),oe=at(!1),H=at(!1),U=at(null);let B=A(Ve(new Set)),F=A(null),$=A(null),P=A("Файл не выбран"),ne=Ye(()=>e(B).size);async function I(){oe.set(!0),U.set(null);try{const v=await fetch(ae);if(!v.ok){const E=await v.json();throw new Error(E.message||"Не удалось загрузить список изображений.")}const b=await v.json();le.set(b.images)}catch(v){U.set(v.message)}finally{oe.set(!1)}}async function J(v){H.set(!0),U.set(null);try{const b=new FormData;b.append("image",v);const E=await fetch(ae,{method:"POST",body:b});if(!E.ok){const Q=await E.json();throw new Error(Q.message||"Не удалось загрузить изображение.")}return U.set(null),await E.json()}catch(b){throw U.set(b.message),b}finally{H.set(!1)}}rt(()=>{I()});function ie(v){const b=new Set(e(B));b.has(v)?b.delete(v):b.add(v),r(B,b,!0)}async function De(){if(!e(F)||e(F).length===0){r($,"Пожалуйста, выберите файл для загрузки.");return}r($,null);try{await J(e(F)[0]),r(F,null),r(P,"Файл не выбран");const v=document.getElementById("imageUploadInput");v&&(v.value=""),await I()}catch(v){r($,v.message,!0)}}function z(v){const b=v.target.files;b.length>0?(r(F,b,!0),r(P,b[0].name,!0)):(r(F,null),r(P,"Файл не выбран"))}function se(){const v=s().filter(b=>e(B).has(b.filename)).map(b=>q+b.url);j("insertImages",v),j("close")}function ke(){j("close")}var x=ea(),y=i(x),T=c(i(y),2),he=c(i(T),2),be=i(he),C=c(be,2),ce=c(i(C),2),ye=i(ce,!0);l(ce),l(C),l(he);var ue=c(he,2),ve=i(ue);{var Te=v=>{var b=Fe("Загрузка...");a(v,b)},me=v=>{var b=Fe("Загрузить");a(v,b)};w(ve,v=>{S()?v(Te):v(me,!1)})}l(ue);var G=c(ue,2);{var de=v=>{var b=Qt(),E=i(b,!0);l(b),O(()=>Y(E,e($))),a(v,b)};w(G,v=>{e($)&&v(de)})}var re=c(G,2);{var Re=v=>{var b=Vt(),E=i(b);l(b),O(()=>Y(E,`Ошибка из стора: ${f()??""}`)),a(v,b)};w(re,v=>{f()&&f().includes("загрузк")&&v(Re)})}l(T);var Se=c(T,4),fe=c(i(Se),2);{var _e=v=>{var b=Wt();a(v,b)},R=v=>{var b=W(),E=L(b);{var Q=t=>{var d=Gt(),k=i(d);l(d),O(()=>Y(k,`Ошибка загрузки: ${f()??""}`)),a(t,d)},n=t=>{var d=W(),k=L(d);{var ee=M=>{var X=Xt();a(M,X)},K=M=>{var X=$t();Ne(X,5,s,Ee=>Ee.filename,(Ee,V)=>{var D=Zt();const te=Ye(()=>e(B).has(e(V).filename));let ge;var Ce=i(D),Me=c(Ce,2);{var Ae=pe=>{var ze=Yt();a(pe,ze)};w(Me,pe=>{e(te)&&pe(Ae)})}l(D),O(pe=>{ge=bt(D,1,"image-item svelte-vbcn1b",null,ge,pe),Be(Ce,"src",e(V).url),Be(Ce,"alt",e(V).filename)},[()=>({selected:e(te)})]),p("click",D,()=>ie(e(V).filename)),a(Ee,D)}),l(X),a(M,X)};w(k,M=>{s().length===0?M(ee):M(K,!1)},!0)}a(t,d)};w(E,t=>{f()?t(Q):t(n,!1)},!0)}a(v,b)};w(fe,v=>{h()?v(_e):v(R,!1)})}l(Se);var xe=c(Se,2),u=i(xe),_=i(u);l(u);var Z=c(u,2);l(xe),l(y),l(x),O(()=>{Y(ye,e(P)),ue.disabled=S(),u.disabled=e(ne)===0,Y(_,`Вставить выбранные (${e(ne)??""})`)}),p("change",be,z),p("click",ue,De),p("click",u,se),p("click",Z,ke),nt(3,x,()=>st),a(we,x),Je(),m()}var aa=g('<textarea class="raw-html-editor svelte-1w4p1za" rows="10" placeholder="Введите HTML-разметку"></textarea>'),na=g('<div contenteditable="true" class="text-editor svelte-1w4p1za"></div>'),sa=g('<div class="toolbar svelte-1w4p1za"><button type="button" class="svelte-1w4p1za"><b>B</b></button> <button type="button" class="svelte-1w4p1za"><i>I</i></button> <button type="button" class="svelte-1w4p1za"><u>U</u></button> <button type="button" class="svelte-1w4p1za">🔗</button> <button type="button" class="svelte-1w4p1za">🔗&#x20E0;</button> <button type="button" class="svelte-1w4p1za"><code>&lt;/&gt;</code></button> <button type="button" class="svelte-1w4p1za"></button> <button type="button" class="svelte-1w4p1za">🚫</button> <!></div> <!>',1),ra=g('<textarea class="images-editor svelte-1w4p1za" placeholder="Введите URL изображений, по одному на строку" rows="5"></textarea> <button type="button" class="action-button add-image-button svelte-1w4p1za">Добавить картинку</button>',1),la=g("<option disabled>Загрузка...</option>"),oa=g("<option disabled> </option>"),ia=g("<option> </option>"),va=g('<div class="keyboard-selection-group svelte-1w4p1za"><select class="svelte-1w4p1za"><option>Нет клавиатуры</option><!></select> <button type="button" class="edit-keyboard-button svelte-1w4p1za"> </button></div>'),ca=g('<input type="text" class="svelte-1w4p1za"/>'),ua=g('<div class="form-group svelte-1w4p1za"><label class="svelte-1w4p1za"> </label> <!></div>'),da=g('<div class="modal-overlay svelte-1w4p1za"><div class="modal-content svelte-1w4p1za"><h3 class="svelte-1w4p1za">Редактировать сообщение</h3> <form><!> <div class="modal-actions svelte-1w4p1za"><button type="submit" class="action-button save-button svelte-1w4p1za">Сохранить</button> <button type="button" class="action-button cancel-button svelte-1w4p1za">Отмена</button></div></form></div></div> <!> <!>',1);function fa(we,o){Pe(o,!0);const N=Ke();let m=Ve({...o.doc,text:o.doc.text?F(o.doc.text):"",images:Array.isArray(o.doc.images)?o.doc.images.join(`
`):"",keyboard_name:o.doc.keyboard_name||""}),s=A(void 0),S=A(void 0),f=A(void 0),h=!1,j=A(!1),ae=A(Ve([])),q=A(!0),le=A(null),oe=A(!1),H=A(null),U=["name","buttons"],B=A(!1);function F(u){if(typeof u!="string")return"";let _=u.replace(/&nbsp;/g," ");return _=_.replace(/\n/g,"<br>"),_}function $(u){if(typeof u!="string")return"";let _=u;_=_.replace(/<br\s*\/?>/gi,`
`),_=_.replace(/<\s*(p|div)\b[^>]*>(.*?)<\/\s*\1\s*>/gis,(v,b,E)=>{let Q=E.replace(/<br\s*\/?>/gi,`
`).replace(/&nbsp;/g," ").trim();return(Q||"")+`

`});const Z="(b|i|u|s|a|code|pre)";return _=_.replace(new RegExp(`<(?!/?(${Z})[^>]*?>)[^>]+>`,"gi"),""),_=_.replace(new RegExp(`</(?!/?(${Z})[^>]*?>)[^>]+>`,"gi"),""),_=_.replace(/&nbsp;/g," "),_=_.replace(/\r/g,""),_=_.replace(/ +/g," "),_=_.trim(),_}function P(u,_=null){e(s)&&(e(s).focus(),document.execCommand(u,!1,_),m.text=e(s).innerHTML,e(s).dispatchEvent(new Event("input")))}function ne(){const u=prompt("Введите URL ссылки:","http://");u&&P("createLink",u)}function I(){P("unlink")}function J(){if(e(s)){e(s).focus();const u=window.getSelection();if(u.rangeCount>0){const Z=u.getRangeAt(0).toString();if(Z)document.execCommand("insertHTML",!1,`<code>${Z}</code>`);else{document.execCommand("insertHTML",!1,"<code></code>");const v=document.createRange();v.selectNodeContents(e(s)),v.collapse(!1),u.removeAllRanges(),u.addRange(v)}}m.text=e(s).innerHTML,e(s).dispatchEvent(new Event("input"))}}function ie(){if(e(s)){e(s).focus();const u=window.getSelection();if(u.rangeCount>0){const Z=u.getRangeAt(0).toString();if(Z)document.execCommand("insertHTML",!1,`<pre>${Z}</pre>`);else{document.execCommand("insertHTML",!1,"<pre></pre>");const v=document.createRange();v.selectNodeContents(e(s)),v.collapse(!1),u.removeAllRanges(),u.addRange(v)}}m.text=e(s).innerHTML,e(s).dispatchEvent(new Event("input"))}}function De(){P("removeFormat")}function z(){h||(m.text=e(s).innerHTML)}function se(u){m.text=u.target.value}function ke(){}async function x(u){r(j,u.detail,!0),e(j)?e(s)&&(m.text=$(e(s).innerHTML)):(await kt(),e(s)&&(h=!0,e(s).innerHTML=F(m.text),h=!1))}async function y(){r(q,!0),r(le,null);try{const u=await fetch("/api/keyboards");if(!u.ok){const Z=await u.json();throw new Error(Z.message||`Failed to fetch keyboards: ${u.statusText}`)}const _=await u.json();r(ae,_,!0),!m.keyboard_name&&e(ae).length>0&&(m.keyboard_name="")}catch(u){r(le,u.message,!0)}finally{r(q,!1)}}function T(){m.keyboard_name?(r(H,e(ae).find(u=>u.name===m.keyboard_name),!0),e(H)||r(H,{name:m.keyboard_name,buttons:[]},!0)):r(H,{name:"",buttons:[]},!0),r(oe,!0)}async function he(u){const _=u.detail;try{const Z=_._id?"PUT":"POST",v=_._id?`/api/keyboards/${_._id}`:"/api/keyboards",{_id:b,...E}=_,Q=await fetch(v,{method:Z,headers:{"Content-Type":"application/json"},body:JSON.stringify(E)});if(!Q.ok){const d=await Q.json();throw new Error(d.message||`Failed to save keyboard: ${Q.statusText}`)}const n=await Q.json(),t=_._id?_:n;await y(),t.name?m.keyboard_name=t.name:m.keyboard_name=""}catch(Z){alert(`Ошибка сохранения клавиатуры: ${Z.message}`)}r(oe,!1),r(H,null)}function be(){r(oe,!1),r(H,null)}function C(){r(B,!0)}function ce(u){const _=u.detail;if(_&&_.length>0){const v=[...m.images.split(`
`).filter(Boolean),..._];m.images=v.join(`
`)}r(B,!1)}function ye(){r(B,!1)}rt(()=>{e(s)&&!e(j)&&(h=!0,e(s).innerHTML=m.text,h=!1),y()}),xt(()=>{!e(j)&&e(s)&&m.text!==e(s).innerHTML&&(h=!0,e(s).innerHTML=F(m.text),h=!1)});function ue(){const u={...m};typeof u.text=="string"&&(u.text=$(u.text)),typeof u.images=="string"&&(u.images=u.images.split(`
`).filter(Boolean)),N("save",u)}function ve(){N("cancel")}var Te=da(),me=L(Te),G=i(me),de=c(i(G),2),re=i(de);Ne(re,17,()=>o.columns,We,(u,_)=>{var Z=W(),v=L(Z);{var b=E=>{var Q=ua(),n=i(Q),t=i(n);l(n);var d=c(n,2);{var k=K=>{var M=sa(),X=L(M),Ee=i(X),V=c(Ee,2),D=c(V,2),te=c(D,2),ge=c(te,2),Ce=c(ge,2),Me=c(Ce,2);Me.textContent="<pre>";var Ae=c(Me,2),pe=c(Ae,2);Rt(pe,{get checked(){return e(j)},label:"Режим разметки",$$events:{change:x}}),l(X);var ze=c(X,2);{var qe=Ue=>{var je=aa();ft(je),vt(je,Qe=>r(S,Qe),()=>e(S)),Ie(je,()=>m.text,Qe=>m.text=Qe),p("input",je,se),a(Ue,je)},Oe=Ue=>{var je=na();vt(je,Qe=>r(s,Qe),()=>e(s)),p("input",je,z),a(Ue,je)};w(ze,Ue=>{e(j)?Ue(qe):Ue(Oe,!1)})}p("click",Ee,()=>P("bold")),p("click",V,()=>P("italic")),p("click",D,()=>P("underline")),p("click",te,ne),p("click",ge,I),p("click",Ce,J),p("click",Me,ie),p("click",Ae,De),a(K,M)},ee=K=>{var M=W(),X=L(M);{var Ee=D=>{var te=ra(),ge=L(te);ft(ge),vt(ge,Me=>r(f,Me),()=>e(f));var Ce=c(ge,2);Ie(ge,()=>m.images,Me=>m.images=Me),p("input",ge,ke),p("click",Ce,C),a(D,te)},V=D=>{var te=W(),ge=L(te);{var Ce=Ae=>{var pe=va(),ze=i(pe),qe=i(ze);qe.value=qe.__value="";var Oe=c(qe);{var Ue=Ge=>{var Ze=la();Ze.value=Ze.__value="",a(Ge,Ze)},je=Ge=>{var Ze=W(),mt=L(Ze);{var pt=$e=>{var Xe=oa(),ot=i(Xe);l(Xe),Xe.value=Xe.__value="",O(()=>Y(ot,`Ошибка: ${e(le)??""}`)),a($e,Xe)},ht=$e=>{var Xe=W(),ot=L(Xe);Ne(ot,17,()=>e(ae),We,(yt,it)=>{var et=ia(),wt=i(et,!0);l(et);var dt={};O(()=>{Y(wt,e(it).name),dt!==(dt=e(it).name)&&(et.value=(et.__value=e(it).name)??"")}),a(yt,et)}),a($e,Xe)};w(mt,$e=>{e(le)?$e(pt):$e(ht,!1)},!0)}a(Ge,Ze)};w(Oe,Ge=>{e(q)?Ge(Ue):Ge(je,!1)})}l(ze);var Qe=c(ze,2),gt=i(Qe,!0);l(Qe),l(pe),O(()=>{ze.disabled=e(q),Y(gt,m.keyboard_name?"Редактировать клавиатуру":"Создать/Редактировать клавиатуру")}),Dt(ze,()=>m.keyboard_name,Ge=>m.keyboard_name=Ge),p("click",Qe,T),a(Ae,pe)},Me=Ae=>{var pe=ca();He(pe),O(()=>Be(pe,"id",e(_))),Ie(pe,()=>m[e(_)],ze=>m[e(_)]=ze),a(Ae,pe)};w(ge,Ae=>{e(_)==="keyboard_name"?Ae(Ce):Ae(Me,!1)},!0)}a(D,te)};w(X,D=>{e(_)==="images"?D(Ee):D(V,!1)},!0)}a(K,M)};w(d,K=>{e(_)==="text"?K(k):K(ee,!1)})}l(Q),O(()=>{Be(n,"for",e(_)),Y(t,`${e(_)??""}:`)}),a(E,Q)};w(v,E=>{e(_)!=="_id"&&E(b)})}a(u,Z)});var Re=c(re,2),Se=c(i(Re),2);l(Re),l(de),l(G),l(me);var fe=c(me,2);{var _e=u=>{_t(u,{get doc(){return e(H)},get columns(){return U},$$events:{save:he,cancel:be}})};w(fe,u=>{e(oe)&&u(_e)})}var R=c(fe,2);{var xe=u=>{ta(u,{$$events:{insertImages:ce,close:ye}})};w(R,u=>{e(B)&&u(xe)})}p("click",Se,ve),p("submit",de,lt(ue)),a(we,Te),Je()}var ba=g("<option disabled>Загрузка...</option>"),_a=g("<option disabled> </option>"),ga=g("<option> </option>"),ma=g("<option disabled>Нет доступных callback_data</option>"),pa=g('<input type="text" list="button-callbacks" placeholder="Введите или выберите callback_data" class="svelte-14e1utc"/> <datalist id="button-callbacks"><!></datalist>',1),ha=g("<option disabled>Загрузка...</option>"),ya=g("<option disabled> </option>"),wa=g("<option> </option>"),xa=g("<option disabled>Нет доступных сообщений</option>"),ka=g('<input type="text" list="message-names" placeholder="Введите или выберите название сообщения" class="svelte-14e1utc"/> <datalist id="message-names"><!></datalist>',1),Sa=g('<input type="text" class="svelte-14e1utc"/>'),Ca=g('<div class="form-group svelte-14e1utc"><label class="svelte-14e1utc"> </label> <!></div>'),Da=g('<div class="form-group svelte-14e1utc"><label for="input_var" class="svelte-14e1utc">Имя переменной для ввода:</label> <input type="text" id="input_var" placeholder="Например: user_age" class="svelte-14e1utc"/></div>'),Ea=g('<div class="modal-overlay svelte-14e1utc"><div class="modal-content svelte-14e1utc"><h2 class="svelte-14e1utc">Редактировать триггер</h2> <form><!> <div class="form-group checkbox-group svelte-14e1utc"><input type="checkbox" id="wait_input_var_checkbox" class="svelte-14e1utc"/> <label for="wait_input_var_checkbox" class="svelte-14e1utc">Ожидать ввод пользователя?</label></div> <!> <div class="modal-actions svelte-14e1utc"><button type="submit" class="action-button save-button svelte-14e1utc">Сохранить</button> <button type="button" class="action-button cancel-button svelte-14e1utc">Отмена</button></div></form></div></div>');function Ta(we,o){Pe(o,!0);let N=Le(o,"columns",19,()=>[]);const m=Ke();let s=A(Ve({...o.doc,wait_input_var:!!o.doc.wait_input_var,input_var:o.doc.wait_input_var?o.doc.input_var||"input":void 0})),S=A(Ve([])),f=A(!0),h=A(null),j=A(Ve([])),ae=A(!0),q=A(null);async function le(){r(f,!0),r(h,null);try{const x=await fetch("/api/buttons");if(!x.ok)throw new Error(`Ошибка загрузки кнопок: ${x.status} ${x.statusText}`);const y=await x.json();r(S,y.filter(T=>T.callback_data).map(T=>({id:T._id,value:T.callback_data,text:T.text||T.label||`Кнопка ${String(T._id).slice(-4)}`})),!0)}catch(x){console.error("Error fetching buttons:",x),r(h,x.message,!0)}finally{r(f,!1)}}async function oe(){r(ae,!0),r(q,null);try{const x=await fetch("/api/message");if(!x.ok)throw new Error(`Ошибка загрузки сообщений: ${x.status} ${x.statusText}`);const y=await x.json();r(j,y.filter(T=>T.name).map(T=>({id:T._id,value:T.name,text:T.text||T.label||T.title||`Сообщение ${String(T._id).slice(-4)}`})),!0)}catch(x){console.error("Error fetching messages:",x),r(q,x.message,!0)}finally{r(ae,!1)}}rt(async()=>{await Promise.allSettled([le(),oe()])});function H(x,y){r(s,{...e(s),[x]:y},!0)}function U(x){const y=x.target.checked;r(s,{...e(s),wait_input_var:y},!0),y&&e(s).input_var===void 0?r(s,{...e(s),input_var:"input"},!0):y||r(s,{...e(s),input_var:void 0},!0)}function B(){m("save",e(s))}function F(){m("cancel")}var $=Ea(),P=i($),ne=c(i(P),2),I=i(ne);Ne(I,17,N,We,(x,y)=>{var T=W(),he=L(T);{var be=C=>{var ce=Ca(),ye=i(ce),ue=i(ye);l(ye);var ve=c(ye,2);{var Te=G=>{var de=pa(),re=L(de);He(re);var Re=c(re,2),Se=i(Re);{var fe=R=>{var xe=ba();xe.value=xe.__value="",a(R,xe)},_e=R=>{var xe=W(),u=L(xe);{var _=v=>{var b=_a(),E=i(b);l(b),b.value=b.__value="",O(()=>Y(E,`Ошибка: ${e(h)??""}`)),a(v,b)},Z=v=>{var b=W(),E=L(b);{var Q=t=>{var d=W(),k=L(d);Ne(k,17,()=>e(S),ee=>ee.id,(ee,K)=>{var M=ga(),X=i(M,!0);l(M);var Ee={};O(()=>{Be(M,"title",e(K).text),Y(X,e(K).value),Ee!==(Ee=e(K).value)&&(M.value=(M.__value=e(K).value)??"")}),a(ee,M)}),a(t,d)},n=t=>{var d=ma();d.value=d.__value="",a(t,d)};w(E,t=>{e(S).length>0?t(Q):t(n,!1)},!0)}a(v,b)};w(u,v=>{e(h)?v(_):v(Z,!1)},!0)}a(R,xe)};w(Se,R=>{e(f)?R(fe):R(_e,!1)})}l(Re),O(()=>Be(re,"id",e(y))),Ie(re,()=>e(s)[e(y)],R=>e(s)[e(y)]=R),p("input",re,R=>H(e(y),R.target.value)),a(G,de)},me=G=>{var de=W(),re=L(de);{var Re=fe=>{var _e=ka(),R=L(_e);He(R);var xe=c(R,2),u=i(xe);{var _=v=>{var b=ha();b.value=b.__value="",a(v,b)},Z=v=>{var b=W(),E=L(b);{var Q=t=>{var d=ya(),k=i(d);l(d),d.value=d.__value="",O(()=>Y(k,`Ошибка: ${e(q)??""}`)),a(t,d)},n=t=>{var d=W(),k=L(d);{var ee=M=>{var X=W(),Ee=L(X);Ne(Ee,17,()=>e(j),V=>V.id,(V,D)=>{var te=wa(),ge=i(te,!0);l(te);var Ce={};O(()=>{Be(te,"title",e(D).text),Y(ge,e(D).value),Ce!==(Ce=e(D).value)&&(te.value=(te.__value=e(D).value)??"")}),a(V,te)}),a(M,X)},K=M=>{var X=xa();X.value=X.__value="",a(M,X)};w(k,M=>{e(j).length>0?M(ee):M(K,!1)},!0)}a(t,d)};w(E,t=>{e(q)?t(Q):t(n,!1)},!0)}a(v,b)};w(u,v=>{e(ae)?v(_):v(Z,!1)})}l(xe),O(()=>Be(R,"id",e(y))),Ie(R,()=>e(s)[e(y)],v=>e(s)[e(y)]=v),p("input",R,v=>H(e(y),v.target.value)),a(fe,_e)},Se=fe=>{var _e=Sa();He(_e),O(()=>Be(_e,"id",e(y))),Ie(_e,()=>e(s)[e(y)],R=>e(s)[e(y)]=R),p("input",_e,R=>H(e(y),R.target.value)),a(fe,_e)};w(re,fe=>{e(y)==="message_name"?fe(Re):fe(Se,!1)},!0)}a(G,de)};w(ve,G=>{e(y)==="pattern"?G(Te):G(me,!1)})}l(ce),O(G=>{Be(ye,"for",e(y)),Y(ue,`${G??""}:`)},[()=>e(y).replace(/_/g," ")]),a(C,ce)};w(he,C=>{e(y)!=="_id"&&C(be)})}a(x,T)});var J=c(I,2),ie=i(J);He(ie),ct(2),l(J);var De=c(J,2);{var z=x=>{var y=Da(),T=c(i(y),2);He(T),l(y),Ie(T,()=>e(s).input_var,he=>e(s).input_var=he),p("input",T,he=>H("input_var",he.target.value)),nt(3,y,()=>st),a(x,y)};w(De,x=>{e(s).wait_input_var&&x(z)})}var se=c(De,2),ke=c(i(se),2);l(se),l(ne),l(P),l($),ut(ie,()=>e(s).wait_input_var,x=>e(s).wait_input_var=x),p("change",ie,U),p("click",ke,F),p("submit",ne,lt(B)),nt(3,$,()=>st),a(we,$),Je()}var Ma=g('<label class="checkbox-wrapper svelte-35b4c8"><input type="checkbox" class="svelte-35b4c8"/> <span class="custom-checkbox"></span> <!></label>');function Aa(we,o){let N=Le(o,"checked",12,!1),m=Le(o,"disabled",8,!1),s=Le(o,"id",8,""),S=Le(o,"name",8,"");var f=Ma(),h=i(f);He(h);var j=c(h,4);Et(j,o,"default",{}),l(f),O(()=>{Be(f,"for",s()),h.disabled=m(),Be(h,"id",s()),Be(h,"name",S())}),ut(h,N),a(we,f)}var Ba=g("<span> </span>"),za=g("<td><!></td>"),Ra=g('<div class="modal-overlay svelte-h5ftc9"><div class="modal-content svelte-h5ftc9"><h3>Подтверждение удаления</h3> <p>Вы уверены, что хотите удалить этот документ?</p> <div class="modal-actions svelte-h5ftc9"><button class="action-button modal-delete-button svelte-h5ftc9">Удалить</button> <button class="action-button modal-cancel-button svelte-h5ftc9">Отмена</button></div></div></div>'),La=g('<tr class="table-row svelte-h5ftc9"><td class="table-cell select-cell svelte-h5ftc9"><!></td><!><td class="table-cell actions-cell svelte-h5ftc9"><button aria-label="Редактировать" class="action-button edit-button svelte-h5ftc9"><svg class="icon svelte-h5ftc9"><use href="/sprite.svg#pen"></use></svg></button> <button aria-label="Удалить" class="action-button delete-button svelte-h5ftc9"><svg class="icon svelte-h5ftc9"><use href="/sprite.svg#trash-bin"></use></svg></button></td></tr> <!> <!>',1);function Na(we,o){Pe(o,!0);let N=Le(o,"columns",19,()=>[]),m=Le(o,"editingId",7,null),s=Le(o,"isMessageRoute",3,!1);const S=Ke();let f=A(!1),h=A(!1),j=Ye(()=>o.doc&&m()===o.doc._id);function ae(){r(f,!0)}function q(){r(f,!1)}function le(){S("delete",o.doc),r(f,!1)}function oe(){r(h,!0)}function H(P){S("save",P.detail),m(null),r(h,!1)}function U(){m(null),r(h,!1)}var B=W(),F=L(B);{var $=P=>{var ne=La(),I=L(ne),J=i(I),ie=i(J);Aa(ie,{get disabled(){return e(j)}}),l(J);var De=c(J);Ne(De,17,N,We,(be,C)=>{var ce=za();let ye;var ue=i(ce);{var ve=me=>{var G=Ba(),de=i(G,!0);l(G),O(re=>Y(de,re),[()=>{var re;return((re=o.doc[e(C)])==null?void 0:re.length)>15?o.doc[e(C)].slice(0,15)+"…":o.doc[e(C)]??"-"}]),a(me,G)},Te=me=>{var G=W(),de=L(G);{var re=Se=>{var fe=Fe();O(_e=>Y(fe,_e),[()=>typeof o.doc[e(C)]=="string"?"…"+o.doc[e(C)].slice(-5):o.doc[e(C)]]),a(Se,fe)},Re=Se=>{var fe=W(),_e=L(fe);{var R=u=>{var _=W(),Z=L(_);{var v=E=>{var Q=Fe();O(n=>Y(Q,n),[()=>`buttons (${o.doc[e(C)].flatMap(n=>Array.isArray(n)?n.length:0).reduce((n,t)=>n+t,0)})`]),a(E,Q)},b=E=>{var Q=Fe("-");a(E,Q)};w(Z,E=>{Array.isArray(o.doc[e(C)])&&o.doc[e(C)].length>0?E(v):E(b,!1)})}a(u,_)},xe=u=>{var _=W(),Z=L(_);{var v=E=>{var Q=Fe();O(n=>Y(Q,n),[()=>Array.isArray(o.doc[e(C)])&&o.doc[e(C)].length>0?`${o.doc[e(C)].length} image(s)`:"-"]),a(E,Q)},b=E=>{var Q=W(),n=L(Q);{var t=k=>{var ee=Fe();O(K=>Y(ee,K),[()=>o.doc[e(C)]?new Date(o.doc[e(C)]).toLocaleDateString("ru-RU"):"-"]),a(k,ee)},d=k=>{var ee=Fe();O(()=>Y(ee,o.doc[e(C)]??"-")),a(k,ee)};w(n,k=>{e(C)==="created_at"?k(t):k(d,!1)},!0)}a(E,Q)};w(Z,E=>{e(C)==="images"?E(v):E(b,!1)},!0)}a(u,_)};w(_e,u=>{e(C)==="buttons"?u(R):u(xe,!1)},!0)}a(Se,fe)};w(de,Se=>{e(C)==="_id"?Se(re):Se(Re,!1)},!0)}a(me,G)};w(ue,me=>{e(C).trim()==="text"?me(ve):me(Te,!1)})}l(ce),O(me=>{ye=bt(ce,1,"table-cell svelte-h5ftc9",null,ye,me),Be(ce,"title",o.doc[e(C)]??"")},[()=>({"name-text":e(C).trim()==="name"})]),a(be,ce)});var z=c(De),se=i(z),ke=c(se,2);l(z),l(I);var x=c(I,2);{var y=be=>{var C=Ra(),ce=i(C),ye=c(i(ce),4),ue=i(ye),ve=c(ue,2);l(ye),l(ce),l(C),p("click",ue,le),p("click",ve,q),a(be,C)};w(x,be=>{e(f)&&be(y)})}var T=c(x,2);{var he=be=>{var C=W(),ce=L(C);{var ye=ve=>{fa(ve,{get doc(){return o.doc},get columns(){return N()},$$events:{save:H,cancel:U}})},ue=ve=>{var Te=W(),me=L(Te);{var G=re=>{_t(re,{get doc(){return o.doc},get columns(){return N()},$$events:{save:H,cancel:U}})},de=re=>{var Re=W(),Se=L(Re);{var fe=R=>{Ta(R,{get doc(){return o.doc},get columns(){return N()},$$events:{save:H,cancel:U}})},_e=R=>{At(R,{get doc(){return o.doc},get columns(){return N()},$$events:{save:H,cancel:U}})};w(Se,R=>{o.selectedCollection==="handlers"?R(fe):R(_e,!1)},!0)}a(re,Re)};w(me,re=>{o.selectedCollection==="keyboards"?re(G):re(de,!1)},!0)}a(ve,Te)};w(ce,ve=>{s()?ve(ye):ve(ue,!1)})}a(be,C)};w(T,be=>{e(h)&&be(he)})}p("click",se,oe),p("click",ke,ae),a(P,ne)};w(F,P=>{o.doc&&P($)})}a(we,B),Je()}var ja=g('<div class="search-input-container svelte-19u0fv4"><input type="text" placeholder="Поиск..." class="search-input svelte-19u0fv4"/> <svg class="icon svelte-19u0fv4"><use href="/sprite.svg#search"></use></svg></div>');function Ha(we,o){Pe(o,!0);let N=A("");const m=Ke();function s(){m("search",e(N))}var S=ja(),f=i(S);He(f),ct(2),l(S),Ie(f,()=>e(N),h=>r(N,h)),p("input",f,s),a(we,S),Je()}var Ia=g("<p>Документы отсутствуют</p>"),Oa=g('<th class="uppercase-header svelte-1x4x36k"> <span class="sort-icon svelte-1x4x36k"> </span></th>'),Ua=g('<div class="table-container svelte-1x4x36k"><div class="tools-panel svelte-1x4x36k"><!> <button class="create-button svelte-1x4x36k"><svg class="icon svelte-1x4x36k"><use href="/sprite.svg#circle-plus"></use></svg> <span class="svelte-1x4x36k">Добавить</span></button></div> <div class="table-wrapper svelte-1x4x36k"><table class="svelte-1x4x36k"><thead class="svelte-1x4x36k"><tr><th class="id-column-header svelte-1x4x36k"></th><!><th class="actions-column-header uppercase-header svelte-1x4x36k">Действия</th></tr></thead><tbody class="svelte-1x4x36k"></tbody></table></div></div>');function Fa(we,o){Pe(o,!0);let N=Le(o,"isMessageRoute",3,!1);const m=Ke();let s=A(null),S=A(null),f=A(!0),h=A("");function j(z){r(h,z.detail,!0)}function ae(z,se){return se.length===0?[]:se}let q=Ye(()=>ae(o.documents,o.orderedFields));function le(z){return e(S)?[...z].sort((se,ke)=>{const x=se[e(S)],y=ke[e(S)];return x==null&&y==null?0:x==null?1:y==null?-1:typeof x=="number"&&typeof y=="number"?e(f)?x-y:y-x:e(f)?String(x).localeCompare(String(y),"ru",{sensitivity:"base"}):String(y).localeCompare(String(x),"ru",{sensitivity:"base"})}):z}function oe(z,se,ke){if(!ke)return z;const x=ke.toLowerCase();return z.filter(y=>se.some(T=>{const he=y[T];return he!=null&&String(he).toLowerCase().includes(x)}))}let H=Ye(()=>{const z=oe(o.documents,e(q),e(h));return le(z)});function U(z){r(s,z.detail._id,!0)}function B(){r(s,null)}function F(z){m("save",z.detail),r(s,null)}function $(z){m("delete",z.detail)}function P(){m("add")}function ne(z){e(S)===z?r(f,!e(f)):(r(S,z,!0),r(f,!0))}var I=W(),J=L(I);{var ie=z=>{var se=Ia();a(z,se)},De=z=>{var se=Ua(),ke=i(se),x=i(ke);Ha(x,{$$events:{search:j}});var y=c(x,2);l(ke);var T=c(ke,2),he=i(T),be=i(he),C=i(be),ce=c(i(C));Ne(ce,17,()=>e(q),We,(ue,ve)=>{var Te=Oa(),me=i(Te),G=c(me),de=i(G,!0);l(G),l(Te),O(()=>{Y(me,`${e(ve)??""} `),Ct(G,`opacity: ${e(S)===e(ve)?1:.2};`),Y(de,e(S)==e(ve)?e(f)?"▲":"▼":"▲")}),p("click",Te,()=>ne(e(ve))),a(ue,Te)}),ct(),l(C),l(be);var ye=c(be);Ne(ye,21,()=>e(H),ue=>ue._id,(ue,ve)=>{Na(ue,{get doc(){return e(ve)},get columns(){return e(q)},get editingId(){return e(s)},get isMessageRoute(){return N()},get selectedCollection(){return o.selectedCollection},$$events:{startEdit:U,cancelEdit:B,save:F,delete:$}})}),l(ye),l(he),l(T),l(se),p("click",y,P),a(z,se)};w(J,z=>{o.documents.length===0?z(ie):z(De,!1)})}a(we,I),Je()}var Ka=g("<p>Загрузка документов...</p>"),Pa=g("<p>Документы отсутствуют.</p>"),Ja=g('<div class="wrap svelte-bzuro2"><!> <!></div>');function vn(we,o){Pe(o,!0);let N=Le(o,"documents",19,()=>[]),m=Le(o,"loading",3,!1),s=Le(o,"isMessageRoute",3,!1),S=Le(o,"displayFields",19,()=>[]);const f=Ke();function h(){if(!o.selectedCollection||S().length===0)return;const B={};for(const F of S())F!=="_id"&&F!=="created_at"&&F!=="updated_at"&&(B[F]="");f("add",B)}function j(B){f("save",B)}function ae(B){f("delete",B)}function q(B,F,$){if(B.length===0)return[];const P=Array.from(new Set(B.flatMap(I=>Object.keys(I))));let ne=[];if(F&&F.length>0?ne=F.filter(I=>P.includes(I)):ne=P,$&&$.length>0){const I=$.filter(ie=>ne.includes(ie)),J=ne.filter(ie=>!I.includes(ie));return[...I,...J]}else return ne}let le=Ye(()=>N().length>0?q(N(),S(),o.orderFields):[]);var oe=W(),H=L(oe);{var U=B=>{var F=Ja(),$=i(F);{var P=J=>{var ie=Ka();a(J,ie)},ne=J=>{var ie=W(),De=L(ie);{var z=se=>{var ke=Pa();a(se,ke)};w(De,se=>{N().length===0&&se(z)},!0)}a(J,ie)};w($,J=>{m()?J(P):J(ne,!1)})}var I=c($,2);Fa(I,{get documents(){return N()},get orderedFields(){return e(le)},get isMessageRoute(){return s()},get selectedCollection(){return o.selectedCollection},$$events:{save:J=>j(J.detail),add:h,delete:J=>ae(J.detail)}}),l(F),a(B,F)};w(H,B=>{o.selectedCollection&&B(U)})}a(we,oe),Je()}export{vn as D};
